$(document).on 'page:load ready', ->
  headings = {
    '#wishlist-review': '<%= I18n.t('refinery.ironman.orders.new.headings.wishlist_review') %>'
    '#wishlist-details': '<%= I18n.t('refinery.ironman.orders.new.headings.wishlist_details') %>'
    '#wishlist-stockist': '<%= I18n.t('refinery.ironman.orders.new.headings.wishlist_stockist') %>'
    '#wishlist-submission': '<%= I18n.t('refinery.ironman.orders.new.headings.wishlist_submission') %>'
  }

  $('#wishlist .next.btn').on 'click', ->
    active = $('#wishlist li.active a[data-toggle="tab"]').attr('href')

    validations = {
      '#wishlist-review': -> true
      '#wishlist-details': ->
        ok = true

        $('input[required=required],textarea[required=required],select[required=required]', active).each ->
          if not $(@).val()
            ok = false

        if not ok
          alert '<%= I18n.t('refinery.ironman.orders.new.required_fields_missing') %>'
        else
          if not $('#terms_conditions').is(':checked')
            alert '<%= I18n.t('refinery.ironman.orders.contact_details.terms_conditions.warning') %>'
            ok = false

        return ok
      '#wishlist-stockist': -> true
    }

    if not validations[active]? or validations[active]()
      nextTab = $(@).data('next-tab')
      $('#wishlist ul[role=tablist] a[href="#' + nextTab + '"]').tab('show').focus().blur()

  setClassesForTabs = (active) ->
    currentIndex = 0

    $('#wishlist ul[role=tablist] a').each (i, tab) ->
      if tab == active
        currentIndex = i

    $('#wishlist ul[role=tablist] li').each (i) ->
      if i < currentIndex
        $(@).addClass 'completed'
      else
        $(@).removeClass 'completed'
      if i > currentIndex
        $(@).addClass 'incomplete'
      else
        $(@).removeClass 'incomplete'

  $('#wishlist a[data-toggle="tab"]').on 'click', (e) ->
    if ($(e.target).closest('li').hasClass('incomplete'))
      e.preventDefault()
      e.stopPropagation()

  $('#wishlist a[data-toggle="tab"]').on 'shown.bs.tab', (e) ->
    setClassesForTabs e.target
    $.cookie 'wishlist-tab', e.target.hash
    $('#layout-heading .page-header').text headings[e.target.hash]

  tab = $.cookie 'wishlist-tab'
  if tab? and tab
    $('#wishlist ul[role=tablist] a[href="' + tab + '"]').tab('show').focus().blur()
    if tab is '#wishlist-review'
      setClassesForTabs active
  else
    active = $('#wishlist li.active a[data-toggle="tab"]').get(0)
    setClassesForTabs active
