<% auto_scroll = false if local_assigns[:auto_scroll].nil? %>
<% first_warehouse = @warehouses.values.flatten.first %>
<script type="text/javascript">
  $(document).on('ready page:load', function() {
    <% if first_warehouse.present? %>
    var warehouses = <%=raw Hash[*first_warehouse.class.all.map{ |w| [w.id, w.slice(:id, :latitude, :longitude)] }.flatten].to_json %>;
    <% else %>
    var warehouses = [];
    <% end %>
    var loaded = false;
    var handleAccordion = function(event, ui) {
      $('li:not(.map-added)', ui.newPanel).each(function() {
        var handler = Gmaps.build('Google');
        var warehouseId = $(this).data('warehouse');
        var li = $(this);

        handler.buildMap({
          provider: {
            disableDefaultUI: true
            // pass in other Google Maps API options here
          },
          internal: {
            id: ('map' + warehouseId)
          }
        }, function(){
          var warehouse = warehouses[warehouseId];
          if (warehouse.latitude != null && warehouse.longitude != null) {
            var m = handler.addMarkers([{lat: warehouse.latitude, lng: warehouse.longitude}]);
            handler.bounds.extendWith(m);
            handler.fitMapToBounds();
            handler.getMap().setZoom(16);
          }

          li.addClass('map-added');
        });
      });

      <% if auto_scroll %>
      if (!loaded) {
        if (ui.newHeader.offset() != null) {
          $(window).scrollTop(ui.newHeader.offset().top);
        }
      }
      loaded = true;
      <% end %>
    };

    $('#warehouses').accordion({
      heightStyle: 'content',
      activate: handleAccordion,
      collapsible: true,
      active: false
    });

    <% if auto_scroll %>
    if ($(document.location.hash).length) {
      $(document.location.hash).trigger('click');
      // this will reposition the page, but should not refresh the page
      document.location.href = document.location.href;
    }
    else {
      $('#warehouses h3:first').trigger('click');
      window.scrollTo(0, 0);
    }
    <% else %>
      $('#warehouses h3:first').trigger('click');
      window.scrollTo(0, 0);
    <% end %>
  });
</script>

<div id="warehouses">
  <% australia = @warehouses.slice('Australia') %>
  <% warehouses = australia.merge(@warehouses.except('Australia')) %>
  <% warehouses.each do |region, warehouses| %>
    <h3 id="<%= region.parameterize %>"><%= region %></h3>
    <div>
      <ul>
      <% warehouses.each do |warehouse| %>
        <li class="row details" data-warehouse="<%= warehouse.id %>">
          <div class="col-sm-8">
            <div id="<%= "map#{warehouse.id}" %>" class="map"></div>
          </div>
          <div class="col-sm-4 warehouse">
            <h4 class="heading" data-warehouse-id="<%= warehouse.id %>"><%= warehouse.name %></h4>
            <% if warehouse.business_name.present? %>
            <div class="business-name"><%= warehouse.business_name %></div>
            <% end %>
            <div class="address"><%= warehouse.address1 %></div>
            <% if warehouse.address2.present? %>
            <div class="address"><%= warehouse.address2 %></div>
            <% end %>
            <div class="address"><%= [warehouse.suburb, warehouse.state, warehouse.postcode].reject(&:blank?).join(', ') %></div>
            <% if warehouse.country.present? %>
            <div class="country"><%= warehouse.country %></div>
            <% end %>
            <% if warehouse.contact.present? %>
            <div class="contact"><%= warehouse.contact %></div>
            <% end %>
            <% if warehouse.phone.present? %>
            <div class="phone">Ph: <%= warehouse.phone %></div>
            <% end %>
            <% if warehouse.respond_to?(:fax) and warehouse.fax.present? %>
            <div class="fax">Fax: <%= warehouse.fax %></div>
            <% end %>
            <% if warehouse.email.present? %>
            <div class="email"><%= mail_to warehouse.email %></div>
            <% end %>
            <% if warehouse.website.present? %>
            <div class="website"><%= link_to warehouse.website, warehouse.website %></div>
            <% end %>
          </div>
        </li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <% # any additional content passed through in a block %>
  <%= yield %>
</div>
