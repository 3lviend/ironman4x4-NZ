<% cache_key = [cache_key_for_stockists, params[:store_type], params[:services], params[:stockist_query]] %> 
<% cache(cache_key) do %>
<% stockists_search_url = refinery.ironman_stockists_path if local_assigns[:stockists_search_url].nil? %>

<% if @stockists.present? %>
<%
  markers = Gmaps4rails.build_markers(@stockists) do |stockist, marker|
    marker.title stockist.name
    marker.lat stockist.latitude
    marker.lng stockist.longitude
    marker.picture({
      url: image_url("stockists_map_marker_#{stockist.map_pin}.png"),
      width: 25,
      height: 47
    })
    marker.infowindow render('refinery/ironman/stockists/marker_info_window', :object => stockist).gsub(/\n/, '')
    marker.json({ :id => stockist.id })
  end
%>


<script type="text/javascript">
  $(document).on('ready page:load', function() {
    window.initStockists = function() {
      var loadStockists = function(currentPosition) {
        var handler = Gmaps.build('Google');
        handler.buildMap({
          provider: {
            disableDefaultUI: true
            // pass in other Google Maps API options here
          },
          internal: {
            id: 'map'
          }
        }, function(){
          var markers = <%=raw markers.to_json %>;
          Gmaps.store = Gmaps.store || {};
          Gmaps.store.markers = markers.map(function(m) {
            var marker = handler.addMarker(m);
            marker.serviceObject.set('id', m.id);
            return marker;
          });

          handler.bounds.extendWith(Gmaps.store.markers);

          if (currentPosition != null) {
            var closest;

            $.each(Gmaps.store.markers, function(){
              var distance = google.maps.geometry.spherical.computeDistanceBetween(
                this.serviceObject.getPosition(), new google.maps.LatLng(
                  currentPosition.coords.latitude,
                  currentPosition.coords.longitude
                )
              );

              if(!closest || closest.distance > distance){
                closest = {marker:this, distance:distance};
              }
            });

            if(closest){
              handler.map.serviceObject.setCenter(
                closest.marker.serviceObject.position
              );
              handler.map.serviceObject.setZoom(12);
            }
          }
          else {
            if (document.location.search != '') {
              handler.fitMapToBounds();
              handler.map.serviceObject.setZoom(12);
            }
            else {
              handler.map.serviceObject.setCenter(
                new google.maps.LatLng(-37.813186, 144.9629796)
              );
              handler.map.serviceObject.setZoom(10);
            }
          }

        });

        $('#stockists .stockist .heading').on('click', function() {
          var stockistId = $(this).data('stockist-id');
          $.each(Gmaps.store.markers, function() {
            if (this.serviceObject.id == stockistId) {
              this.panTo();
              this.serviceObject.setAnimation(google.maps.Animation.BOUNCE);
            }
            else this.serviceObject.setAnimation(null);
          });
        });
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(currentPosition) {
          loadStockists(currentPosition);
        }, loadStockists);
      }
      else {
        loadStockists();
      }
    };

    // don't auto init for wishlist page
    if (!document.location.href.match('wishlist')) {
      initStockists();
    }
  });
</script>
<% end %>

<%= render :partial => 'refinery/ironman/stockists/filters', :locals => {:url => stockists_search_url} %>

<% if @stockists.present? %>
<ul id="stockists" class="clearfix">
  <% @stockists.each_with_index do |stockist, index| %>
    <li class="stockist col-sm-6 col-lg-4">
      <hr />
      <div class="heading row" data-stockist-id="<%= stockist.id %>">
        <div class="num col-xs-1 col-sm-2"><%= (index+1).to_s.rjust(2, '0') %></div>
        <div class="name col-xs-11 col-sm-10"><%= stockist.name %></div>
      </div>
      <% if stockist.store_type.present? %>
      <div class="row">
        <div class="field store-type col-sm-offset-2 col-sm-10"><%= stockist.store_type %><%= ", #{stockist.notes}" if stockist.notes.present? %></div>
      </div>
      <% end %>
      <div class="row">
        <div class="field address col-sm-offset-2 col-sm-10"><%= stockist.full_street_address %></div>
      </div>
      <% if stockist.contact.present? %>
      <div class="row">
        <div class="field contact col-sm-offset-2 col-sm-10"><%= stockist.contact %></div>
      </div>
      <% end %>
      <% if stockist.website.present? %>
      <div class="row">
        <div class="field website col-sm-offset-2 col-sm-10"><%= link_to stockist.website, stockist.website %></div>
      </div>
      <% end %>
      <% if stockist.email.present? %>
      <div class="row">
        <div class="field email col-sm-offset-2 col-sm-10"><%= mail_to stockist.email, stockist.email %></div>
      </div>
      <% end %>
      <% if stockist.facebook_page.present? %>
      <div class="row">
        <div class="field facebook col-sm-offset-2 col-sm-10"><%= link_to t('.visit_us_on_facebook'), stockist.facebook_page %></div>
      </div>
      <% end %>
    </li>
  <% end %>
</ul>
<% else %>
  <p class="not-found"><%= t('.not-found') %></p>
<% end %>
<% end %>
