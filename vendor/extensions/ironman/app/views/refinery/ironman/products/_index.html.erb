<% if @this_category.present? %>
  <% cache_key = [@this_category] %>
<% else %>
  <% cache_key = [] %>
<% end %>

<% if @vehicle_filter.present? %>
  <% cache_key = cache_key.push @vehicle_filter %>
<% end %>

<% cache([cache_key_for_products, cache_key]) do %>
<% if @category.present? %>
  <%= render :partial => 'refinery/ironman/categories/filters', :locals => {category: @category, subcategory: @subcategory, sub_subcategory: @sub_subcategory, cache_key:cache_key} %>
  <hr />
<% end %>

<% if not @products.present? %>
  <% if @vehicle_filter.present? %>
  <p><%= t('.no_products_found_with_filter_applied') %></p>
  <% else %>
  <p><%= t('.no_products_found') %></p>
  <% end %>
<% end %>

<% if @products.present? %>
<ul id="page-product-list" class="clearfix">
<% @products.each do |product| %>
  <% if @category.present? and @subcategory.present? and @sub_subcategory.present? %>
  <% url = refinery.products_sub_subcategory_product_path(@sub_subcategory, @subcategory, @category, product) %>
  <% elsif @category.present? and @subcategory.present? %>
  <% url = refinery.products_subcategory_product_path(@subcategory, @category, product) %>
  <% elsif @category.present? %>
  <% url = refinery.products_category_product_path(@category, product) %>
  <% else %>
  <% url = refinery.ironman_product_path(product) %>
  <% end %>

  <%= render :partial => 'refinery/ironman/products/index_product', :locals => {product: product, url: url} %>
<% end %>
</ul>
<% end %>
<% end %>
