<% cache(cache_key) do %>
<%
  if @vehicle_filter.present?
    categories = Refinery::Ironman::Category.all.includes(:products => [:vehicles]).references(:products => [:vehicles]).where('(refinery_ironman_vehicles.id in (?) or (refinery_ironman_vehicles.id is null and refinery_ironman_products.id is not null))', @vehicle_filter.values).map(&:root).uniq
  else
    categories = Refinery::Ironman::Category.roots
  end
%>

<%= form_tag refinery.ironman_products_path, {:method => :get, :class => 'form-inline product-category-filters'} do %>
  <div class="form-group">
    <%= label_tag :category_1st_id, t('.category.label') %>
    <%= styled_select_tag :category_1st_id, options_from_collection_for_select(categories, 'slug', 'name', (category.slug if category.present?)), :prompt => t('.category.prompt'), :class => 'input-sm' %>
  </div>

  <div class="form-group">
  <%= label_tag :category_2nd_id, t('.subcategory.label') %>
  <%= styled_select_tag :category_2nd_id, options_from_collection_for_select(if category.present? then category.children else [] end, 'slug', 'name', (subcategory.slug if subcategory.present?)),
                 'data-option-dependent' => true,
                 'data-option-observed' => 'category_1st_id',
                 'data-option-url' => '/categories/:category_1st_id:/children.json',
                 'data-option-key-method' => :slug,
                 'data-option-value-method' => :name,
                 :prompt => t('.subcategory.prompt'),
                 :class => 'input-sm' %>
  </div>

  <div class="form-group">
  <%= label_tag :category_3rd_id, t('.subsubcategory.label') %>
  <%= styled_select_tag :category_3rd_id, options_from_collection_for_select(if subcategory.present? then subcategory.children else [] end, 'slug', 'name', (sub_subcategory.slug if sub_subcategory.present?)),
                 'data-option-dependent' => true,
                 'data-option-observed' => 'category_2nd_id',
                 'data-option-url' => '/categories/:category_2nd_id:/children.json',
                 'data-option-key-method' => :slug,
                 'data-option-value-method' => :name,
                 :prompt => t('.subsubcategory.prompt'),
                 :class => 'input-sm' %>
  </div>
<% end %>
<% end %>
